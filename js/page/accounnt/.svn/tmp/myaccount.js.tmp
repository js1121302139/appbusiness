mui.init();

(function($) {
	mui.plusReady(function() {
		window.addEventListener("getInfodata", function() {
			getInfodata();
		})
		var allWebview = plus.webview.all();
		var exitBox = document.querySelector("#exit"); //退出登录按钮
		//退出登录
		exitBox.addEventListener("tap", function() {
			mui.confirm('是否退出登录？', '提示', ['取消', '确认'], function(e) {
				if(e.index == 1) {
					plus.storage.clear();
					//关闭所有打开页面
					for(var i = 1; i < allWebview.length; i++) {
						plus.webview.close(allWebview[i].id);
					}
				}
			}, 'div')
		})

		//打开页面
		var pages = {
			"#msgCneter": {
				page: "../work/msgcenter",
			},
			"#safeCenter": {
				page: "./safeCenter"
			},
			"#helpCenter": {
				page: "./helpCenter"
			},
			"#aboutyundui": {
				page: "./aboutyundui"
			}
		};
		Fun_App.openWinS(pages)

		/*mui.plusReady(function() {
			nowEdition = plus.runtime.version;
			var EditionCodeBox = document.querySelector(".EditionCode");
			EditionCodeBox.innerText += nowEdition;

		})
		//版本管理
		document.querySelector("#Edition").addEventListener("tap", function() {
			if(nowEdition != nextEdition) {
				alert()
			} 
		})*/
		setTimeout(function(){
			getInfodata();			
		},0)

		var os = plus.os.name;
		var msgState = Fun_App.getdata("pushMsg");
		var sizeBox = document.querySelector("#Size"),
			msgBtnBox = document.querySelector("#msgBtn"),
			clearSizeBox = document.querySelector("#clearSize");
		//设置是否提示消息
		if(msgState == null) {
			Fun_App.storagedata("pushMsg", true)
		}
		msgBtnBox.addEventListener("tap", function() {
			var isActive = document.getElementById("msgBtn").classList.contains("mui-active");
			Fun_App.storagedata("pushMsg", isActive);
			console.log(Fun_App.getdata("pushMsg"))
		})
		//是否显示清除缓存
		/*if(os == "iOS") {
			clearSizeBox.style.display = "none"; 
		}*/ 

		//获取缓存
		getSize()

		function getSize() {
			plus.cache.calculate(function(size) {
				sizeBox.innerText =(size / 1024 / 1024).toFixed(2) + "M";
			})
		}
		//清除缓存
		clearSizeBox.addEventListener("tap", function() {
			var token = Fun_App.getdata("token");
			var isOneOpen = Fun_App.getdata("isOneOpen");
			mui.confirm("确认清除所有缓存数据么？", "提示", ["确定", "取消"], function(index) {
				if(index.index == 0) {
					plus.cache.clear(function() {
						mui.toast("清除成功!");
						getSize();
					});
				}
			})
		})

		function getVersion() {
			var sendData = {
				config: {
					"token": Fun_App.getdata("token"),
					"version": plus.runtime.version, //版本号
					"type": plus.os.name == "iOS" ? 2 : 1 //1 android；2 ios'
				},
				fun_Success: function(data) {
					if(plus.runtime.version != data.version) {
						document.querySelector("#newVersion").style.display = "block"
					} else {
						document.querySelector("#newVersion").style.display = "none"
						document.querySelector("#Edition a").innerText += " "+plus.runtime.version
					}
				}
			}
			Fun_App.ExAjax("merchantPerson/getVersion", sendData);
		}
		getVersion()

		function getInfodata() {
			var myHeadImgBox = document.querySelector("#myHeadImg"),
				myNameBox = document.querySelector("#myName"),
				feedbackBtnBox = document.querySelector("#feedbackBtn"),
				callNumBox = document.querySelector(".callNum")
				myPhoneNumBox = document.querySelector("#myphoneNum");
			var sendData = {
				config: {
					"token": Fun_App.getdata("token")
				},
				fun_Success: function(data) {
					myHeadImgBox.src = picservice + data.data.logoImg; //logo
					myNameBox.innerText = data.data.personCharge;
					myPhoneNumBox.innerText = data.data.personChargePhone;
					feedbackBtnBox.querySelector(".shopPeople").innerText += data.data.invitePhone;
					feedbackBtnBox.querySelector("a").setAttribute("href", data.data.invitePhone)
				}
			}
			callNumBox.addEventListener("tap", function() {
				var callTel = this.querySelector("a").getAttribute("href");
				console.log(callTel)
				plus.device.dial(callTel, true);
			})
			Fun_App.ExAjax("merchantPerson/index", sendData)
		}

	})
})(mui);