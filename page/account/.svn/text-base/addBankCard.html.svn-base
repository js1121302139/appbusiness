<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>兌咖-添加銀行卡</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/mui.picker.min.css">
		<link rel="stylesheet" href="../../css/mui.poppicker.css">
		<link rel="stylesheet" type="text/css" href="../../css/page/account/addBankCard.css" />
	</head>

	<body>
		<div id="addBankCard">
			<header class="mui-bar topBar mui-bar-nav">
				<a class="mui-action-back topBack-ico mui-pull-left"></a>
				<h1 class="mui-title" v-text="isSeeCard==false?'查看银行卡':'添加银行卡'"></h1>
			</header>

			<div class="mui-content">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<span class="userName">姓名</span>
						<input :disabled="!isSeeCard" type="text" maxlength="15" v-model="pageData.bankUser" placeholder="请输入持卡人姓名">
					</li>
					<li class="mui-table-view-cell">

						<span class="bankName">选择银行</span>
						<button :disabled="!isSeeCard" id='showUserPicker' @click="addBank" class="mui-btn mui-btn-block" type='button' v-text="pageData.bankName==null?'请选择银行':pageData.bankName"></button>

					</li>
					<li class="mui-table-view-cell">
						<span class="userName">银行卡号</span>
						<input :disabled="!isSeeCard" type="tel" maxlength="19" v-model="pageData.bankCode" placeholder="请输入银行卡号">
					</li>
					<li class="mui-table-view-cell">

						<span class="bankName">开户行所在地</span>
						<button :disabled="!isSeeCard" id='showCityPicker3' class="mui-btn mui-btn-block" @click="bankAddr" type='button' v-text="bankAddress==null?'请选择地址':bankAddress">请选择地址</button>

					</li>
				</ul>
				<div class="phoneCode" v-if="isSeeCard">
					<input type="number" v-model="pageData.messageCode" placeholder="请输入手机验证码">
					<button href="javascript:;" class="getPhoneCode" :disabled="showOutTime" @click="smsVerify" v-text="second==90?'获取验证码':'剩余'+second+'秒'"></button>
				</div>
				<div v-if="isSeeCard" class="footerButton mui-text-center" id="addBankCardbtn" @click="addBankCard">
					提交
				</div>
			</div>

		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/addressArr.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/mui.poppicker.js"></script>
	<script type="text/javascript" src="../../js/muihelper.js"></script>
	<!--	<script src="../../js/page/accounnt/bindBankCard.js"></script>-->
	<script src="../../js/vue.min.js"></script>
	<script type="text/javascript">
		var Vue = new Vue({
			el: "#addBankCard",
			data: function() {
				return {
					pageData: {
						token: Fun_App.getdata("token"),
						bankName: null,
						bankUser: null,
						bankCode: null,
						bankProvince: null,
						bankCity: null,
						bankArea: null,
						messageCode: null
					},
					bankAddress: null,
					showOutTime: false, // 显示倒计时
					second: 90, // 总计时
					bankCardAddress:null,// 这个是接口获取地址
					isSeeCard: false
				}
			},
			created: function() {
				var _this = this;
				mui.plusReady(function() {
					var id = Fun_App.getextrasdata();
					if(id != null && id != 'null') {
						_this.seeBankCard(function(resData) {
							_this.pageData.bankUser = resData.bankUser
							_this.pageData.bankName = resData.bankName
							_this.pageData.bankCode = resData.bankCode
							_this.bankAddress = resData.bankNameBranch
						}, id)
					} else {
						_this.isSeeCard = true;
						_this.getBankAddress(function(resData){
							_this.bankCardAddress = resData.replace(/\\/g,'');
							
						})
					}
					
				})
			},
			methods: {
				// 银行的名称
				addBank: function() {
					var _this = this;
					var Bank = new mui.PopPicker()
					Bank.setData([{
						text: '建设银行'
					}, {
						text: '中国银行'
					}, {
						text: '工商银行'
					}, {
						text: '农业银行'
					}, {
						text: '招商银行'
					}, {
						text: '光大银行'
					}, {
						text: '民生银行'
					}, {
						text: '兴业银行'
					}, {
						text: '交通银行'
					}, {
						text: '中信银行'
					}, {
						text: '华夏银行'
					}, {
						text: '邮政银行'
					}]);
					Bank.show(function(items) {
						_this.pageData.bankName = items[0].text;
					});
				},
				// 添加银行的地址
				bankAddr: function() {
					var Add = new mui.PopPicker({
						layer: 3
					});
					var _this = this;
					Add.setData(JSON.parse(_this.bankCardAddress));
					Add.show(function(items) {
						_this.pageData.bankProvince = items[0].value;
						_this.pageData.bankCity = items[1].value;
						_this.pageData.bankArea = items[2].value;
						_this.bankAddress = items[0].text + '-' + items[1].text + '-' + items[2].text
					})
				},
				// 添加银行卡
				addBankCard: function() {
					if(Fun_App.checkObjIsNull(this.pageData, '') != false) {
						var sendData = {
							config: this.pageData,
							fun_Success: function(data) {
								if(data.success) {
									mui.alert('添加银行卡成功!', '提示', '知道了!', function(e) {
										e.index
									}, 'div');
								} else {
									mui.toast(data.message);
								}
							}
						}
						Fun_App.ExAjax("merchantPerson/bindingBankCard", sendData)
					} else {
						mui.toast('还有东西没有填写哦!')
					}
				},
				// 获取银行地址
				getBankAddress: function(callBack) {
					var sendData = {
						config: {
							token: Fun_App.getdata("token")
						},
						fun_Success: function(data) {
							console.log(Fun_App.getdata('token'))
							callBack(data.data)
						}
					}
					Fun_App.ExAjax("merchantPerson/getAllAddress", sendData)
				},
				// 查看銀行卡
				seeBankCard: function(callBack, id) {
					var sendData = {
						config: {
							token: Fun_App.getdata("token"),
							bankCardId: id
						},
						fun_Success: function(data) {
							callBack(data.data)
						}
					}
					Fun_App.ExAjax("merchantPerson/previewBankCard", sendData)
				},
				// 发送短信验证码
				timeOut: function() {
						this.showOutTime = true;
						this.second--;
						if(this.second < 1) {
							this.showOutTime = false;
							this.second = 90;
						} else {
							var timeout = setTimeout(this.timeOut, 1000);
						}
					},
				smsVerify: function() {
					var _this = this;
					var sendData = {
						config: {
							token: Fun_App.getdata("token"),
							type: 5
						},
						fun_Success: function(data) {
							if(data.success) {
								mui.toast(data.message)
								_this.timeOut();
							}else{
								mui.toast(data.message)
							}
						}
					}
					if(this.showOutTime == false) {
						mui.plusReady(function() {
							Fun_App.ExAjax("merchant/smsVerify", sendData);
						})
					}
				}
			}

		})
	</script>

</html>