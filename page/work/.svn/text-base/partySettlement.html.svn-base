<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/pullToRefresh.css" />
		<link rel="stylesheet" href="../../css/page/work/partySettlement.css">
	</head>

	<body>
		<div id="partySettlement">
			<header>
				<div class="topNav">
					<a class="mui-action-back topBack-ico mui-pull-left"></a>
					<span id="" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right" @click="open">申请结算</span>
				</div>
				<div class="settlementInfo">
					<div class="settlementInfoL">
						<p class="orderMoney"><b v-html="pageData.settleMoneyTotal==undefined?0:pageData.settleMoneyTotal + applyState.Text"></b>可结算金额 </p>
						<p class="orderNum">订单数
							<small v-text="pageData.orderPartyNumber">50</small>
						</p>
					</div>
					<div class="settlementInfoR" v-show="showIco">
					</div>
				</div>
			</header>
			<div id="wrapper" class="wrapperList">
				<ul id="yyaccountList">
					<li class="wrapperListItem" v-for="(item,key) in pageData.orderParties">
						<div class="ListItem-Tit">
							<div class="itemTit-orderNum" v-text="'订单号:'+item.orderSn">
								订单号: 1611111111111
							</div>
							<div class="itemTit-orderDate mui-text-right " v-text="item.createTime">
								2017-04-20 16:20
							</div>
						</div>
						<div class="ListItem-Info">
							<div class="order-People">
								<div class="order-PeopleImg"><img class="order-PeopleImg" :src="picservice + item.headImg" alt=""></div>
								<div class="order-PeopleInfo mui-ellipsis" v-text="item.memberName">罗炼羽 </div>
							</div>
							<div class="order-Income">
								<p>数&nbsp; &nbsp;&nbsp;量:<span> {{item.number}}</span></p>
								<p>总金额:<span> {{item.moneyTotal}}</span></p>
								<p>类&nbsp; &nbsp;&nbsp;型:<span> {{item.type==3?'购票':'众筹'}}</span></p>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../js/muihelper.js"></script>
	<script type="text/javascript" src="../../js/iscroll.js"></script>
	<script type="text/javascript" src="../../js/pullToRefresh.js"></script>
	<script type="text/javascript" src="../../js/vue.min.js"></script>
	<script type="text/javascript">
		var Vue = new Vue({
			el: "#partySettlement",
			data: function() {
				return {
					page: 1,
					totalPage: null,
					pageLen: pageLen,
					orderId: null,//订单ID
					pageData: {},//页面数据
					showIco: false,//是否显示已结束图标
					picservice: picservice,//图片服务地址
					StateCode: {
						0: '未结算',
						1: '审核中',
						2: '已结算',
						3: '退款'
					},
					applyState: {//申请结算的状态
						id: null,
						Text: ""
					} 
				}
			},
			created: function() {
				var _this = this;
				mui.plusReady(function() {
					window.addEventListener("getListData", function() {
						_this.getListData(_this.orderId, function(resData) {
							_this.pageData = resData.data;
							_this.totalPage = Math.ceil(_this.page / resData.total);
							_this.controlIco();
							_this.applyState.id = resData.data.settlementStatus;
							_this.applyState.Text = '<span>' + _this.StateCode[resData.data.settlementStatus] + '</span>'
						})
					})
					_this.orderId = Fun_App.getextrasdata();
					refresher.init({
						id: "wrapper",
						pullUpAction: _this.Load
					});
					//获取列表
					_this.getListData(_this.orderId, function(resData) {
						_this.pageData = resData.data;
						_this.totalPage = Math.ceil(_this.page / resData.total);
						_this.controlIco();
						_this.applyState.id = resData.data.settlementStatus;
						_this.applyState.Text = '<span>' + _this.StateCode[resData.data.settlementStatus] + '</span>'
					})
				})

			},
			methods: {
				getListData: function(id, callBack) {
					var sendData = {
						config: {
							token: Fun_App.getdata("token"),
							id: id
						},
						fun_Success: function(data) {
							callBack(data)

						}
					}
					Fun_App.ExAjax("merchantParty/playKaOrders", sendData)
				},
				controlIco: function() {
					var nowDate = new Date().getTime(),
						endTime = new Date(this.pageData.endTime.replace(/-/g, "/")).getTime();
					this.showIco = (endTime < nowDate);
				},
				open: function() {
					var _this = this;
					//判断当前的状态为0则是未结算 && endTime<startTime
					if(this.applyState.id == 0 && this.showIco && this.pageData.settleMoneyTotal!=0) {
						mui.plusReady(function() {
							Fun_App.openWin("../work/applysettlement.html", "pop-in", {
								msgtype: 6,
								money: _this.pageData.settleMoneyTotal,
								id: _this.orderId
							})
						})
					}else{
						mui.toast('可结算金额大于0并且活动已结束才可结算!')
					}

				},
				Load: function() {
					wrapper.refresh();
				}
			}
		})
	</script>

</html>