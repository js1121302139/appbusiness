<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/pullToRefresh.css" />
		<link rel="stylesheet" type="text/css" href="../../css/page/work/msgcenter.css" />

	</head>

	<body>
		<div id="message">
			<header class="mui-bar topBar mui-bar-nav">
				<a class="mui-action-back topBack-ico mui-pull-left"></a>
				<h1 class="mui-title"> 系统消息</h1>
				<span id="TopMsg" class="mui-btn  Topactivity mui-btn-blue mui-btn-link mui-pull-right" @click="read">朕已阅</span>
			</header>
			<div id="wrapper" class="wrapperList">
				<ul id="msgList">
					<li class="ListItem" v-for="(item,key) in list" @click="open(item)">
						<p class="msgDate mui-text-center" v-text="item.createTime">2017-06-10 16:00:00</p>
						<div class="msgInfo">
							<div class="msgTop">
								<h1 class="msgTit mui-ellipsis" v-text="item.title">一下下下下 </h1>
								<div class="msg-ico">
									<span class="msgBadge" v-show="!item.status"></span>
								</div>
							</div>
							<div class="msgimg" v-if="item.desPicture!=''">
								<img :src="picservice + item.desPicture" alt="">
							</div>
							<p class="magText mui-ellipsis" v-text="item.pTitle">福利大放送哦121321福利123132123大放送哦福利大放送哦福利大放送哦</p>
						</div>
					</li>
					<!--<li class="ListItem">
							<p class="msgDate mui-text-center">2017-06-10 16:00:00</p>
							<div class="msgInfo">
								<div class="msgTop">
									<h1 class="msgTit mui-ellipsis">一下下下下 </h1>
									<div class="msg-ico">
										<span class="msgBadge"></span>
									</div>
								</div>
								<div class="msgimg">
									<img src="../../img/ico-data02.png" alt="">
								</div>
								<p class="magText mui-ellipsis">福利大放送哦121321福利123132123大放送哦福利大放送哦福利大放送哦</p>
							</div>
						</li>-->
				</ul>
			</div>
			<div class="isNoData"  :class="{scale1:isNoData}"> 
				<div class="isNoDataInfo mui-text-center">
					<div class="isNoDataBg"></div>
					<p class="isNoDataTit">暂无消息</p>
				<p>一有消息小兑立马通知您~</p> 
				</div>
				
				</div>
			</div>

		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../js/muihelper.js"></script>
	<!--<script type="text/javascript" src="../../js/page/work/msgcenter.js"></script>-->
	<script type="text/javascript" src="../../js/iscroll.js"></script>
	<script type="text/javascript" src="../../js/pullToRefresh.js"></script>
	<script type="text/javascript" src="../../js/vue.min.js"></script>
	<script type="text/javascript">
		var Vue = new Vue({
			el: "#message",
			data: function() {
				return {
					list: [],
					picservice: picservice,
					page: 1, 
					totalPage: null,
					pageLen: pageLen,
					isNoData:true
				} 
			},
			created: function() {
				var _this = this;
				mui.plusReady(function() {
					refresher.init({
						id: "wrapper",
						pullUpAction: _this.Load 
					});
					_this.messageList(function(resData) {
						_this.list = resData.data;
						(resData.total<1)?_this.isNoData=false:_this.isNoData=true;
						_this.totalPage = Math.ceil(resData.total / _this.pageLen);
					}, 1)
					window.addEventListener("messageList", function() {
						_this.messageList(function(resData) {
							_this.list = resData.data;
							_this.totalPage = Math.ceil(resData.total / _this.pageLen);
						}, 1)
					})
				})
			},
			methods: {
				messageList: function(callBack, page) {
					var sendData = {
						config: {
							"token": Fun_App.getdata("token"),
							'pageIndex': page
						},
						fun_Success: function(data) {
							var datas = data;
							for(var i = 0; i < datas.data.length; i++) {
								if(datas.data[i].status == 1) {
									datas.data.push(datas.data[i])
									datas.data.splice(i, 1);
								}
							}
							callBack(datas);
						}
					}
					Fun_App.ExAjax("merchant/message", sendData);
				},
				open: function(data) {
					mui.plusReady(function() {
						Fun_App.openWin('./messageArticle.html', "pop-in", data);
					})
				},
				read: function() {
					var mseeageId = []
					for(var i = 0; i < this.list.length; i++) {
						if(this.list[i].status == 0) {
							mseeageId.push(this.list[i].adminMessageId)
							this.list[i].status = 1;
						}
					}
					var sendData = {
						config: {
							"token": Fun_App.getdata("token"),
							"adminMessageIds": mseeageId
						},
						fun_Success: function(data) {
							if(data.success == true) {};
						}
					}
					//Fun_App.ExAjax("merchant/read", sendData);
				},
				Load: function() {
					this.page++;
					var _this = this;
					if(this.page <= this.totalPage) {
						this.messageList(function(resData) {
							_this.list = _this.list.concat(resData.data);
						}, this.page)
					} else {
						refresher.info.pullUpLable = '没有更多数据了!';
					}
					wrapper.refresh();
				}
			}

		})
	</script>

</html>